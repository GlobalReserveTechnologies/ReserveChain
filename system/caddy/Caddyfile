:443 {
  tls internal

  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Referrer-Policy "no-referrer"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
  }

  # Block dotfiles and common secret/backup file extensions
  @blocked path_regexp blocked (^|/)\.(?!well-known)(.*)$
  respond @blocked 404

  @badext path_regexp badext \.(bak|old|swp|tmp|log|sql|sqlite|sqlite3|env|key|pem)$
  respond @badext 404

  # Workstation SPA served at /workstation
  handle_path /workstation/* {
    root * /opt/reservechain/web/workstation
    try_files {path} /index.html
    file_server
  }

  # Node API proxied to localhost
  handle_path /api/* {
    reverse_proxy 127.0.0.1:8080
  }

  # Marketing PHP site
  root * /opt/reservechain/web/marketing
  php_fastcgi unix//run/php/php-fpm.sock
  file_server
}

:80 {
  redir https://{host}{uri}
}
